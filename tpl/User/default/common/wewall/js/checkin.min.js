!function(i){if(i.checkin)return!1;var e={},t={popupDisplay:3e3,speedView:200,speedRemove:400,speedTitle:400,_flip_moving:["flip","turn","cross","diagonal","rotate"],_state:{0:"头像区域为空，初始状态",1:"已经添加了新的签到用户,等待翻牌",4:"翻牌动画进行中",5:"已经翻牌完毕，等待展示气泡",9:"气泡动画展示中",10:"气泡展示完毕，等待新签到的人替换"}},n=i.checkin={};n._cnf={},n._ajaxObj=null,n._pollTimer=null,n._list=null,n._played_list=null,n._lastId=0,n._checkinBox=null,n._checkinLayer=null,n._total=0,n._idbCached=!1,n._dbVersion=2,n._dbName="",n._syncLocalTimer=null,n._isAutoShowQr=null,n.init=function(e){this._cnf=$.extend({},e),this._dbName="checkin_"+i.getConf("companyId");var t=this,n="memoryStorage";t._list=new i.LinkList({name:"ckin-"+i.getConf("companyId"),storeType:n,unique:"id"}),t._played_list=new i.LinkList({name:"ckinp-"+i.getConf("companyId"),storeType:n,unique:"id"}),t._playing_list=new i.LinkList({name:"ckinpg-"+i.getConf("companyId"),storeType:n,unique:"id"}),t._list.clear(),t._played_list.clear(),t._playing_list.clear();var s=function(){t._checkinBox=$("#checkinBox"),t._checkinLayer=$("#checkinLayer"),t.initDom(28),t.bindEvent()};i.indexedDB?($(function(){$.indexedDB(t._dbName,{schema:{2:function(i){i.createObjectStore("list_store",{keyPath:"storeId"})}}}).done(function(){window.setTimeout(function(){i.pub("checkin.indexedDB.ready")},200)})}),i.sub("checkin.indexedDB.ready",function(){i.DEBUG&&i.log("checkin.indexedDB.ready"),$.indexedDB(t._dbName,t._dbVersion).objectStore("list_store").get(1).done(function(e){i.DEBUG&&i.log("list_store_item from indexedDB:",e);var n=Math.ceil((new Date).getTime()/1e3),o="",a="checkin-cnf-"+i.getConf("companyId"),c=localStorage.getItem(a);c&&(c=JSON.parse(c),o=c.checkinVisibleTime),o!=t._cnf.checkinVisibleTime&&i.DEBUG&&i.log("checkin: localTime != me._cnf.checkinVisibleTime"),o==t._cnf.checkinVisibleTime&&e&&e.time&&n-e.time<=1800&&(t._idbCached=!0,t._list.clear(e.data.list_store),t._playing_list.clear(e.data.playing_list_store),t._played_list.clear(e.data.played_list_store)),s()}).fail(function(){s()})})):s()},n.initDom=function(e){var t=this,s=!1;if(window.localStorage&&this._idbCached){var o="checkin-dom-"+i.getConf("companyId"),a=localStorage.getItem(o);if(a){var c=Math.ceil((new Date).getTime()/1e3);a=JSON.parse(a),c-a.time<=86400&&(s=!0,t._checkinBox.html(a.html),$.each(t._checkinBox.children("li"),function(){var i=$(this).attr("data-state"),e=$(this);if(9==i){var n=e.find(".user-block.in").find(".checkinWords");n&&n.length&&t.completePop(n)}else 4==i?t.flip(e,function(i,e){t.showPop(e)}):5==i?t.showPop(e):e.find(".user-block.in").find(".checkinAvatar").length&&e.find(".user-block.in").find(".checkinAvatar").width()>100&&(e.find(".user-block.in").find(".checkinAvatar").css({marginTop:"0",marginLeft:"0",top:"0",left:"0",width:"100px",height:"100px",padding:"0px"}),e.find(".user-block.in").find(".checkinWords").remove())}),t._lastId=a.lastId)}}if(!s){for(var l="",r=0;e>r;r++)l+=n.renderOne();this._checkinBox.html(l);var d=this.getCols();this._checkinBox.children("li:nth-child("+d+"n)").css("marginRight",0),$.each(t._checkinBox.children("li"),function(){t.randomFlipMoving($(this))})}},n.syncToLocal=function(){if(!i.indexedDB)return i.DEBUG&&i.log("checkin.syncToLocal: indexedDB not support"),!1;var e=this,t=e._played_list._storage._s._store,n=e._playing_list._storage._s._store,s=e._list._storage._s._store,o={list_store:s,playing_list_store:n,played_list_store:t};$.indexedDB(e._dbName,e._dbVersion).objectStore("list_store")["delete"](1).done(function(){$.indexedDB(e._dbName,e._dbVersion).objectStore("list_store").add({storeId:1,data:o,time:Math.ceil((new Date).getTime()/1e3)}).then()}).fail(function(){$.indexedDB(e._dbName,e._dbVersion).objectStore("list_store").add({storeId:1,data:o,time:Math.ceil((new Date).getTime()/1e3)}).then()});var a={};a.html=e._checkinBox.html(),a.lastId=e._lastId,a.time=Math.ceil((new Date).getTime()/1e3),a=JSON.stringify(a);var c="checkin-dom-"+i.getConf("companyId");localStorage.setItem(c,a),c="checkin-cnf-"+i.getConf("companyId"),localStorage.setItem(c,JSON.stringify(e._cnf))},n.renderOne=function(){var i='      <li data-state="0">         <div class="user-block in" data-id="0">           <a href="javascript:void(0);"><img class="checkin-avatar checkinAvatar cki-default" src="images/checkin_default.jpg"></a>           <span class="checkin-name checkinName">求上墙</span>         </div>         <div class="user-block out" data-id="0">           <a href="javascript:void(0);"><img class="checkin-avatar checkinAvatar cki-default" src="images/checkin_default.jpg"></a>           <span class="checkin-name checkinName">求上墙</span>         </div>       </li>';return i},n.on=function(){this.poll(),this.show(),i.progress.restart(),this.syncToLocal()},n.off=function(){this.pollStop(),this.hide()},n.show=function(){this.renderTotalNum(),this._checkinLayer.css("visibility","visible"),this._total?($(".checkinQr").hide(),$(".checkinContainer").css("visibility","visible"),this._isAutoShowQr=!1,this._checkinLayer.css({height:"auto",overflow:"visible"})):($(".checkinContainer").css("visibility","hidden"),$(".checkinQr").show(),this._checkinLayer.css({height:"540px",overflow:"hidden"}),this._isAutoShowQr=!0),$(".wordList").css("visibility","hidden"),$(".checkinWordList").css("visibility","visible")},n.toggleQr=function(){this._isAutoShowQr=!1,this._checkinLayer.css("visibility","visible"),$(".checkinQr:visible").length?($(".checkinQr").hide(),$(".checkinContainer").css("visibility","visible"),this._checkinLayer.css({height:"auto",overflow:"visible"})):($(".checkinContainer").css("visibility","hidden"),$(".checkinQr").show(),this._checkinLayer.css({height:"540px",overflow:"hidden"}))},n.hide=function(){this._checkinLayer.css("visibility","hidden"),$(".checkinContainer").css("visibility","hidden"),$(".wordList").css("visibility","visible"),$(".checkinWordList").css("visibility","hidden")},n.pollStop=function(){return clearTimeout(this._pollTimer),this._pollTimer=null,this._ajaxObj&&(this._ajaxObj.abort(),this._ajaxObj=null),this},n.poll=function(){this.pollStop();var e=i.url("message/checkin_sync?last_id="+this._lastId),t=this;this._ajaxObj=$.get(e,function(e){i.pub("network.ok"),"ok"!=e.info&&i.DEBUG&&i.log("checkin_sync failed: ",e),e.message_list&&t.add(e.message_list),t._total=e.total,t.renderTotalNum(e.total),t._isAutoShowQr&&t.show(),t._pollTimer=setTimeout(function(){t.poll()},7e3)},"json").error(function(e){t._pollTimer=setTimeout(function(){t.poll()},7e3),e.readyState<2&&"error"==textStatus&&i.pub("network.disconnected",e)})},n.add=function(e){if(!e||!e.length)return i.pub("message.checkin.addCompleted"),!1;this._lastId=e[e.length-1].id;for(var t=0;t<e.length;t++){if(i.preLoadAvatar(e[t].avatar),this.getElem(e[t].id,this._played_list))var n=this.getElem(e[t].id,this._list);n?this._list.edit({id:e[t].id},e[t]):this._list.push(e[t])}return this.syncToLocal(),this},n.renderTotalNum=function(i){i=i||this._total,$(".messageTotal").text(i).siblings("span").text("人签到")},n.addOneToDom=function(){var e=this._checkinBox.children('li[data-state="0"]');if(e.length||(e=this._checkinBox.children('li[data-state="10"]')),!e.length)return i.DEBUG&&i.log("checkin.addOneToDom failed: no dom place to store"),!1;if(0==this._list.length())return i.DEBUG&&i.log("checkin.addOneToDom failed: no new user"),"no_user";var t=this._list.shift();t||i.throwErr("checkin.addOneToDom failed: this._list.shift error"),this.getElem(t.cid,this._playing_list)||this._playing_list.push(t.data),newUser=t.data;var n=$(e[i.rand(0,e.length-1)]),s=(n.find(".user-block.in"),n.find(".user-block.out"));return s.attr("data-id",newUser.id).find(".checkinAvatar").attr("src",newUser.avatar).removeClass("cki-default"),s.find(".checkinName").html(newUser.username),n.attr("data-state",1),n},n.showOne=function(){var e=this.addOneToDom();if(!e)return i.DEBUG&&i.log("checkin.showOne failed: addOneToDom return false"),void 0;if("no_user"==e){var t=this._checkinBox.children('li[data-state="10"]');if(!t.length)return i.DEBUG&&i.log("checkin.showOne failed: no finished dom"),!1;var n=$(t[i.rand(0,t.length-1)]);return this.showPop(n),this.syncToLocal(),!1}var s=this;this.flip(e,function(i,e){s.showPop(e)})},n.getElem=function(i,e){var t=e.getElemByPointer(i);return t&&"head"!=t.data?t:!1},n.bindEvent=function(){var e=this;i.sub("event.progress.compelete",function(){"checkin"==i.getState()&&e.showOne()}),i.sub("key.81.down",function(){"checkin"==i.getState()?i.setState("message"):i.setState("checkin")}),$(".btnCheckin").click(function(e){i.pub("key.81.down",e)})},n.getFontSize=function(e){var t=60,n=230,s=492;e=i.trim(e),-1!=e.indexOf("<img")&&(e=e.replace(/\<img.+?\>/g,"")?e.replace(/\<img.+?\>/g,"11"):""),-1!=e.indexOf("<span")&&-1!=e.indexOf("emoji")&&(e=e.replace(/<span.+?emoji.+?><\/span>/g,"")?e.replace(/<span.+?emoji.+?><\/span>/g,"11"):"");var o=i.fontNum(e);if(!o)return t;var a=Math.sqrt(s*n/o)/1.4;return a>t&&(a=t),a},n.getCols=function(){if(e.getCols)return e.getCols;var i=this._checkinBox.width(),t=parseInt(this._checkinBox.children("li").css("margin-right")),n=this._checkinBox.children("li").width(),s=Math.floor((i+t)/(n+t));return e.getCols=s,e.getCols},n.getRows=function(){var i=this._checkinBox.children("li").length;return Math.ceil(i/this.getCols())},n.getCurrentRow=function(i){return Math.ceil((i.index()+1)/this.getCols())},n.getCurrentColIndex=function(i){var e=this.getCols(),t=i.index()+1;return t%e==0?e:t%e},n.getMiddleColArr=function(){var i=this.getCols(),e=[];return i%2==1?e.push(Math.ceil(i/2)):(e.push(i/2),e.push(i/2+1)),e},n.isMiddleCol=function(e){var t=this.getCurrentColIndex(e),n=this.getMiddleColArr();return-1!=i.inArray(t,n)?!0:!1},n.isLeftCol=function(i){var e=this.getCurrentColIndex(i),t=this.getMiddleColArr();return e<t[0]?!0:!1},n.isRightCol=function(i){var e=this.getCurrentColIndex(i),t=this.getMiddleColArr();return e>t[t.length-1]?!0:!1},n.getSharpClassName=function(i){var e=(this.getRows(),this.getCurrentRow(i)),t="";return this.isMiddleCol(i)?t=2>=e?"topside":"bottomside":this.isRightCol(i)?t=2>=e?"rightside":"rightside2":this.isLeftCol(i)&&(t=2>=e?"leftside":"leftside2"),t},n.showPop=function(e){var n=e.find(".user-block.in"),s=n.find(".checkinAvatar"),o=parseInt(n.attr("data-id")),a=this.getElem(o,this._list);if(a||(a=this.getElem(o,this._playing_list)),a||(a=this.getElem(o,this._played_list)),!a)return i.DEBUG&&i.log("checkin.showPop failed: getElem failed"),!1;var c=a.data.content,l=this.getFontSize(c);if(e.css({"z-index":"10"}),e.addClass("hover"),s.stop().animate({marginTop:"-80px",marginLeft:"-80px",top:"50%",left:"50%",width:"150px",height:"150px",padding:"0px"},{duration:t.speedView,compelete:function(){w.syncToLocal()}}),0!=c.length){n.find(".checkinWords").length?n.find(".checkinTitle").html(c):n.prepend('<div class="checkinWords checkin-words"><div> <i>  </i><pre><span class="checkinTitle">'+c+"</span></pre></div></div>");var r=this.getCurrentRow(e),d=n.find(".checkinWords"),h=0;d.css("position","absolute").children("div").css("width","auto"),h=d.children("div").width(),d.css("position","static").children("div").css("width",h);var f='<p><span class="checkinTitle">'+c+"</span></p>";d.find("pre").remove(),d.find("i").after(f),d.show().find(".checkinTitle").css("font-size",l);var u=d.height(),p=h+4,g=150,_=150,m=46,v=this.getSharpClassName(e);if(d.find("i").addClass(v),"topside"==v||"bottomside"==v){var k=(p-30)/2-20;d.find("i").css("left",k+"px")}var y=0,b=0;"leftside"==v||"leftside2"==v?(y=g,b=-(u-_)-m):"rightside"==v||"rightside2"==v?(y=-p-m,b=-(u-_)-m):"bottomside"==v?(y=-(p-g)/2-15,b=-u-m):"topside"==v&&(y=-(p-g)/2-15,b=_),2>=r&&"topside"!=v&&"bottomside"!=v&&(b=-10),d.closest("li").attr("data-state","9");var w=this;d.animate({left:y+"px",top:b+"px"},{duration:t.speedTitle,complete:function(){w.syncToLocal();var i=$(this);w.completePop(i)}}).css({"z-index":"10",position:"absolute","float":"left"})}},n.completePop=function(e,n){var s=this,o=e.closest("li"),a=o.find(".user-block.in");n=void 0===n?t.popupDisplay:0,setTimeout(function(){e.closest("li").attr("data-state","10"),o.css({"z-index":"8"}),o.removeClass("hover"),a.find(".checkinAvatar").stop().animate({marginTop:"0",marginLeft:"0",top:"0",left:"0",width:"100px",height:"100px",padding:"0px"},{duration:t.speedRemove,compelete:function(){s.syncToLocal()}}),a.find(".checkinWords").remove();var n=parseInt(a.attr("data-id"));if(!n)return i.DEBUG&&i.log("checkin.showPop complete: can not get id from userBlockFront"),void 0;var c=s.getElem(n,s._playing_list);return c?(s.getElem(n,s._played_list)||s._played_list.push(c.data),s._playing_list["delete"]("id",n),s.syncToLocal(),void 0):(i.DEBUG&&i.log("checkin.showPop complete: can not get elem from _playing_list"),void 0)},n)},n.randomFlipMoving=function(e){var n=e.find(".user-block"),s=t._flip_moving[i.rand(0,t._flip_moving.length-1)];$.each(n,function(){$(this).removeClass(t._flip_moving.join(" ")).addClass(s)})},n.flip=function(i,e){var t=i.find(".user-block.in"),n=i.find(".user-block.out"),s=this;return i.attr("data-state",4),t.addClass("out").removeClass("in"),this.syncToLocal(),setTimeout(function(){s.syncToLocal(),n.addClass("in").removeClass("out"),setTimeout(function(){i.attr("data-state",5),s.syncToLocal(),e&&e(null,i)},150)},125),this}}(wxscreen);