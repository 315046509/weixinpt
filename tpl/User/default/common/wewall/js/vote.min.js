!function(t){if(t.vote)return!1;var o=t.vote={};o._voteInfo=null,o._prevVoteInfo=null,o._barMap=["","progress-bar-first","progress-bar-second","progress-bar-third"],o._timer=null,o._ajaxObj=null,o._eventInited=!1,o.init=function(o){return this._prevVoteInfo=this._voteInfo,this._voteInfo=o,this._voteInfo?($(".voteClosedBox").hide(),$(".voteOpendBox").show(),this.render(),this.center()):($(".voteClosedBox").show(),$(".voteOpendBox").hide(),t.DEBUG&&t.log("vote.init failed: voteInfo is empty")),this._eventInited||this.initEvent(),this},o.render=function(){return $(".voteTitle").html(this._voteInfo.title),$(".voteIntro").html(this._voteInfo.intro),$(".voteJoinNum").text(this._voteInfo.join_count),this.renderOption(),this},o.renderOption=function(){var o=$(".voteOptionBox"),e=this,n=this._voteInfo.option_list.length,i=[];if(this._prevVoteInfo&&n==this._prevVoteInfo.option_list.length){for(var r=!1,s=0;n>s;s++)if(this._voteInfo.option_list[s].id!=this._prevVoteInfo.option_list[s].id){r=!0;break}if(!r){for(var s=0;n>s;s++)this.renderOptionOne(this._voteInfo.option_list[s],!0,this._prevVoteInfo.option_list[s]);return this}}$.each(this._voteInfo.option_list,function(t){this.viewOrder=t+1,i.push(e.renderOptionOne(this))});var l=0,v=0,h=[],a=0,p=0;if($(".optionRow ul:eq(0)").html(""),$(".optionRow ul:eq(1)").html(""),$(".optionRow ul:eq(2)").html(""),5>=n?(v=1,p=5):10>=n?(v=2,p=5):15>=n?(v=3,p=5):(v=3,p=6),v){l=0;for(var s=1;s<=i.length&&(h[l]||(h[l]=0),h[l]++,h[l]>=p&&l++,!(l>=v));s++);}return t.DEBUG&&t.log("vote.render boxNums:",h),a=0,$.each(h,function(t,o){return o?($(".optionRow ul:eq("+t+")").html(i.slice(a,a+o).join("")),a+=o,void 0):!1}),this.resetViewOrder(),o.removeClass("one-row two-row three-row three-row-five").addClass(this.getOptionClass()),this},o.resetViewOrder=function(){var t=1;$.each($(".optionRow ul:eq(0)").children("li"),function(){$(this).find(".voteViewOrder").text(t++)}),$.each($(".optionRow ul:eq(1)").children("li"),function(){$(this).find(".voteViewOrder").text(t++)}),$.each($(".optionRow ul:eq(2)").children("li"),function(){$(this).find(".voteViewOrder").text(t++)})},o.renderOptionOne=function(o,e,n){var i=this._barMap[parseInt(o.rank)]||"",r=parseInt(this._voteInfo.vote_count&&o.option_count)?(o.option_count/this._voteInfo.vote_count*100).toFixed(1):0;if(e){var s=parseInt(this._prevVoteInfo.vote_count&&n.option_count)?(n.option_count/this._prevVoteInfo.vote_count*100).toFixed(1):0,l=$('.voteOptionBox li[data-id="'+o.id+'"]');if(!l||!l.length)return t.DEBUG&&t.log("vote.renderOptionOne error: update failed, option dom not exists."),!1;var v=l.find(".voteOptionBar");return l.find(".voteOptionTitle").html(o.option_content),l.find(".voteOptionP").text(r+"%"),l.find(".voteOptionCount").text(o.option_count),v.removeClass($.trim(this._barMap.join(" "))).addClass(i),s!=r&&(v.css({width:0}),setTimeout(function(){v.animate({width:r+"%"})},400)),!0}var h='            <li class="clearfix" data-id="'+o.id+'">              <span class="votenum voteViewOrder">'+o.viewOrder+'</span>              <div class="example">                <p class="vote-topic voteOptionTitle">'+o.option_content+'</p>                <div class="progress">                  <div class="progress-bar voteOptionBar '+i+'" style="width:'+r+'%;">                    <p class="words-tips"><span class="sr-only voteOptionP">'+r+'%</span><span> <em class="voteOptionCount">'+o.option_count+"</em>票</span></p>                  </div>                </div>              </div>            </li>";return h},o.getOptionClass=function(){var t=this._voteInfo.option_list.length;return 5>=t?"one-row":10>=t?"two-row":15>=t?"three-row-five":"three-row"},o.sync=function(){if(this._ajaxObj){try{this._ajaxObj.abort()}catch(o){t.DEBUG&&t.log("vote.sync: _ajaxObj.abort error")}this._ajaxObj=null}var e=this;this._ajaxObj=$.post(t.url("vote/current"),function(o){"ok"!=o.info?t.showMsg(o.info):e.init(o.vote_info)},"json").error(function(o,e){t.DEBUG&&t.log("vote.sync failed: ajax-error",e)})},o.poll=function(){this.pollStop();var t=this;this._timer=setInterval(function(){t.sync()},5e3)},o.pollStop=function(){return clearInterval(this._timer),this._timer=null,this},o.on=function(){this.sync(),$("#vote_layer").fadeIn(),this.poll();try{t.ddp&&t.ddp.off(),t.lottery&&t.lottery.off()}catch(o){t.DEBUG&&t.log("vote.on off other failed",o)}},o.off=function(){$("#vote_layer").hide(),this.pollStop()},o.show=function(){t.setState("vote")},o.hide=function(){t.setState("message")},o.initEvent=function(){var o=this;$(".btnVote").click(function(){return t.getConf("votePlug")?($("#vote_layer:visible").length?o.hide():o.show(),void 0):(t.showMsg("您还没有开通投票功能，详情咨询客服"),void 0)}),$(".voteCloseBtn").click(function(){o.hide()}),t.sub("key.84.down",function(){$(".btnVote").trigger("click")}),this._eventInited=!0},o.center=function(){var o,e=$(".optionRow ul:eq(0)").find("li"),n=t._height(e.eq(0)),i=n*e.length;o=this._voteInfo.option_list.length<=10?5*n:6*n;var r=0;return o>i&&(r=(370-i)/2),$(".voteOptionBox").css({"margin-top":r+"px"}),this}}(wxscreen);